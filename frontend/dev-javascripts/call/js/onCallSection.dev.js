let svg_callAudioOffIcon = `<svg width="90" height="100" viewBox="0 0 90 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M62.8859 53.6463C64.2407 50.9209 64.9585 47.9218 64.9848 44.8767V19.8206C64.9295 14.8705 63.0496 10.116 59.7071 6.47296C56.3647 2.82991 51.7961 0.556018 46.8815 0.089318C41.9668 -0.377382 37.0538 0.996121 33.0888 3.94525C29.1238 6.89437 26.3873 11.2105 25.4065 16.0622M79.9765 44.8767C79.9765 43.5476 79.45 42.273 78.5129 41.3332C77.5757 40.3934 76.3046 39.8655 74.9793 39.8655C73.6539 39.8655 72.3828 40.3934 71.4457 41.3332C70.5085 42.273 69.982 43.5476 69.982 44.8767C69.9675 49.2548 68.7763 53.548 66.5339 57.3045L73.8799 64.9215C77.9014 59.0189 80.0286 52.0252 79.9765 44.8767ZM44.9957 64.9215H45.7953L25.0067 44.0248V44.8767C25.0067 50.1929 27.1127 55.2914 30.8614 59.0505C34.61 62.8097 39.6943 64.9215 44.9957 64.9215ZM88.5218 86.4196L8.56575 6.24022C8.09982 5.77299 7.54667 5.40235 6.93789 5.14949C6.32912 4.89662 5.67664 4.76647 5.0177 4.76647C4.35877 4.76647 3.70629 4.89662 3.09751 5.14949C2.48874 5.40235 1.93559 5.77299 1.46965 6.24022C0.52865 7.18385 0 8.46369 0 9.79818C0 11.1327 0.52865 12.4125 1.46965 13.3561L81.4257 93.5355C81.8903 94.0052 82.443 94.378 83.0519 94.6324C83.6609 94.8869 84.3141 95.0178 84.9738 95.0178C85.6335 95.0178 86.2866 94.8869 86.8956 94.6324C87.5046 94.378 88.0573 94.0052 88.5218 93.5355C88.9902 93.0697 89.362 92.5154 89.6157 91.9048C89.8694 91.2941 90 90.6391 90 89.9776C90 89.316 89.8694 88.661 89.6157 88.0504C89.362 87.4397 88.9902 86.8855 88.5218 86.4196Z" />
<path d="M59.9875 89.9776H49.993V79.5543C52.8209 79.1595 55.59 78.419 58.2385 77.3493L50.2429 69.3314C48.5229 69.7346 46.7621 69.9364 44.9957 69.9327C38.369 69.9327 32.0136 67.2929 27.3278 62.594C22.6419 57.8951 20.0095 51.5219 20.0095 44.8767C20.0095 43.5476 19.483 42.273 18.5458 41.3332C17.6086 40.3934 16.3376 39.8655 15.0122 39.8655C13.6869 39.8655 12.4158 40.3934 11.4786 41.3332C10.5415 42.273 10.015 43.5476 10.015 44.8767C10.0248 53.3048 13.0603 61.4476 18.5662 67.8154C24.072 74.1832 31.6801 78.3502 39.9985 79.5543V89.9776H30.004C28.6786 89.9776 27.4076 90.5055 26.4704 91.4453C25.5332 92.3851 25.0067 93.6597 25.0067 94.9888C25.0067 96.3178 25.5332 97.5925 26.4704 98.5323C27.4076 99.472 28.6786 100 30.004 100H59.9875C61.3129 100 62.5839 99.472 63.5211 98.5323C64.4583 97.5925 64.9848 96.3178 64.9848 94.9888C64.9848 93.6597 64.4583 92.3851 63.5211 91.4453C62.5839 90.5055 61.3129 89.9776 59.9875 89.9776Z" />
</svg>
`
let svg_callAudioOnIcon = `<svg width="70" height="100" viewBox="0 0 70 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M35 65C40.3043 65 45.3914 62.8929 49.1421 59.1421C52.8929 55.3914 55 50.3043 55 45V20C55 14.6957 52.8929 9.60859 49.1421 5.85786C45.3914 2.10714 40.3043 0 35 0C29.6957 0 24.6086 2.10714 20.8579 5.85786C17.1071 9.60859 15 14.6957 15 20V45C15 50.3043 17.1071 55.3914 20.8579 59.1421C24.6086 62.8929 29.6957 65 35 65Z" />
<path d="M70 45C70 43.6739 69.4732 42.4021 68.5355 41.4645C67.5979 40.5268 66.3261 40 65 40C63.6739 40 62.4021 40.5268 61.4645 41.4645C60.5268 42.4021 60 43.6739 60 45C60 51.6304 57.3661 57.9893 52.6777 62.6777C47.9893 67.3661 41.6304 70 35 70C28.3696 70 22.0107 67.3661 17.3223 62.6777C12.6339 57.9893 10 51.6304 10 45C10 43.6739 9.47321 42.4021 8.53553 41.4645C7.59785 40.5268 6.32608 40 5 40C3.67392 40 2.40215 40.5268 1.46447 41.4645C0.526785 42.4021 0 43.6739 0 45C0.00985554 53.4092 3.04704 61.5338 8.5559 67.8874C14.0648 74.2409 21.677 78.3987 30 79.6V90H19.45C18.2698 90 17.1379 90.4688 16.3034 91.3034C15.4688 92.1379 15 93.2698 15 94.45V95.55C15 96.7302 15.4688 97.8621 16.3034 98.6966C17.1379 99.5312 18.2698 100 19.45 100H50.55C51.7302 100 52.8621 99.5312 53.6966 98.6966C54.5312 97.8621 55 96.7302 55 95.55V94.45C55 93.2698 54.5312 92.1379 53.6966 91.3034C52.8621 90.4688 51.7302 90 50.55 90H40V79.6C48.323 78.3987 55.9352 74.2409 61.4441 67.8874C66.953 61.5338 69.9901 53.4092 70 45Z" />
</svg>
`

let svg_callSwitchViewToMultipleIcon = `<svg width="100" height="90" viewBox="0 0 100 90"  xmlns="http://www.w3.org/2000/svg">
<path d="M82.2562 4.75573e-07C79.9255 4.24627e-07 77.6176 0.476164 75.4644 1.40131C73.3111 2.32645 71.3546 3.68246 69.7066 5.3919C68.0585 7.10134 66.7512 9.13073 65.8593 11.3642C64.9674 13.5977 64.5083 15.9916 64.5083 18.4091C64.5083 20.8266 64.9674 23.2204 65.8593 25.4539C66.7512 27.6874 68.0585 29.7168 69.7066 31.4263C71.3546 33.1357 73.3111 34.4917 75.4644 35.4169C77.6176 36.342 79.9255 36.8182 82.2562 36.8182C86.9632 36.8171 91.477 34.8765 94.8046 31.4233C98.1322 27.9702 100.001 23.2873 100 18.4049C99.9989 13.5225 98.128 8.84053 94.7989 5.38894C91.4698 1.93735 86.9551 -0.00110851 82.2481 4.75573e-07H82.2562ZM17.7479 4.75573e-07C15.4172 4.24627e-07 13.1093 0.476164 10.956 1.40131C8.80278 2.32645 6.84627 3.68246 5.19822 5.3919C3.55018 7.10134 2.24289 9.13073 1.35098 11.3642C0.459063 13.5977 0 15.9916 0 18.4091C0 20.8266 0.459063 23.2204 1.35098 25.4539C2.24289 27.6874 3.55018 29.7168 5.19822 31.4263C6.84627 33.1357 8.80278 34.4917 10.956 35.4169C13.1093 36.342 15.4172 36.8182 17.7479 36.8182C22.4549 36.8171 26.9687 34.8765 30.2963 31.4233C33.6239 27.9702 35.4927 23.2873 35.4917 18.4049C35.4906 13.5225 33.6197 8.84053 30.2906 5.38894C26.9615 1.93735 22.4549 -0.00110851 17.7479 4.75573e-07Z" />
<path d="M82.2562 53.1818C79.9255 53.1818 77.6176 53.658 75.4644 54.5831C73.3111 55.5083 71.3546 56.8643 69.7066 58.5737C68.0585 60.2831 66.7512 62.3125 65.8593 64.546C64.9674 66.7795 64.5083 69.1734 64.5083 71.5909C64.5083 74.0084 64.9674 76.4022 65.8593 78.6357C66.7512 80.8692 68.0585 82.8986 69.7066 84.6081C71.3546 86.3175 73.3111 87.6735 75.4644 88.5987C77.6176 89.5238 79.9255 90 82.2562 90C86.9632 89.9989 91.477 88.0583 94.8046 84.6051C98.1322 81.152 100.001 76.4691 100 71.5867C99.9989 66.7043 98.128 62.0223 94.7989 58.5707C91.4698 55.1192 86.9551 53.1807 82.2481 53.1818H82.2562ZM17.7479 53.1818C15.4172 53.1818 13.1093 53.658 10.956 54.5831C8.80278 55.5083 6.84627 56.8643 5.19822 58.5737C3.55018 60.2831 2.24289 62.3125 1.35098 64.546C0.459063 66.7795 0 69.1734 0 71.5909C0 74.0084 0.459063 76.4022 1.35098 78.6357C2.24289 80.8692 3.55018 82.8986 5.19822 84.6081C6.84627 86.3175 8.80278 87.6735 10.956 88.5987C13.1093 89.5238 15.4172 90 17.7479 90C22.4549 89.9989 26.9687 88.0583 30.2963 84.6051C33.6239 81.152 35.4927 76.4691 35.4917 71.5867C35.4906 66.7043 33.6197 62.0223 30.2906 58.5707C26.9615 55.1192 22.4549 53.1807 17.7479 53.1818Z" />
</svg>
`
let svg_callSwitchViewToSingleIcon = `<svg width="100" height="100" viewBox="0 0 100 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M0 50C2.79451e-07 63.2608 5.26785 75.9785 14.6447 85.3553C24.0215 94.7321 36.7392 100 50 100C63.2608 100 75.9785 94.7321 85.3553 85.3553C94.7321 75.9785 100 63.2608 100 50C100 36.7392 94.7321 24.0215 85.3553 14.6447C75.9785 5.26785 63.2608 0 50 0C36.7392 0 24.0215 5.26785 14.6447 14.6447C5.26785 24.0215 0 36.7392 0 50Z" />
</svg>
`
let svg_callRoomInfoIcon = `<svg width="50" height="100" viewBox="0 0 50 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M38.2174 0C45.5 0 49.1413 4.56 49.1413 9.785C49.1413 16.31 42.8152 22.345 34.5815 22.345C27.6848 22.345 23.663 18.595 23.8533 12.395C23.8533 7.18 28.6413 0 38.2174 0ZM15.8098 100C10.0598 100 5.84783 96.74 9.86956 82.38L16.4674 56.92C17.6141 52.85 17.8043 51.215 16.4674 51.215C14.7446 51.215 7.28804 54.025 2.86956 56.8L0 52.4C13.9783 41.47 30.0598 35.065 36.962 35.065C42.7065 35.065 43.663 41.43 40.7935 51.215L33.2337 77.975C31.8967 82.7 32.4674 84.33 33.8098 84.33C35.5326 84.33 41.1848 82.37 46.7391 78.295L50 82.365C36.4022 95.1 21.5489 100 15.8098 100Z" />
</svg>
`
let svg_callSecureRoomIcon = `<svg width="90" height="100" viewBox="0 0 90 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M45 99.9988C43.2528 100.027 41.5289 99.5894 40 98.7309L38.5001 97.8687C26.8165 91.1641 17.0966 81.4344 10.3327 69.6734C3.5688 57.9124 0.00335021 44.5413 0.000400756 30.9255V30.2155C-0.0154488 28.4196 0.439089 26.6517 1.31756 25.0924C2.19603 23.5331 3.46692 22.2383 5.00036 21.3404L40 1.35889C41.5202 0.468667 43.2447 0 45 0C46.7554 0 48.4798 0.468667 50 1.35889L84.9996 21.3404C86.5331 22.2383 87.804 23.5331 88.6824 25.0924C89.5609 26.6517 90.0155 28.4196 89.9996 30.2155V30.9255C89.9866 44.5513 86.4061 57.9292 79.6241 69.6912C72.8422 81.4531 63.1021 91.1771 51.3999 97.8687L49.9 98.7309C48.4007 99.5723 46.7134 100.009 45 99.9988Z" />
</svg>
`
let svg_callDefaultRoomPicIcon = `<svg width="100" height="100" viewBox="0 0 100 100"  xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_4)">
<path d="M89.3125 0.25H33.0625C31.6496 0.241762 30.2491 0.51293 28.9414 1.04791C27.6337 1.58289 26.4447 2.37112 25.4428 3.36727C24.4408 4.36342 23.6457 5.54783 23.1031 6.85237C22.5605 8.15692 22.2812 9.55587 22.2812 10.9687V67.2188C22.2521 68.6406 22.5071 70.0539 23.0311 71.3759C23.5552 72.6979 24.3378 73.9021 25.3331 74.9178C26.3285 75.9335 27.5165 76.7403 28.8277 77.2911C30.1388 77.8418 31.5466 78.1253 32.9687 78.125H90.0937C92.8097 77.9187 95.3452 76.6862 97.1852 74.6779C99.0252 72.6696 100.032 70.0361 100 67.3125V11.0625C100.012 9.64965 99.7453 8.2483 99.2141 6.93904C98.6829 5.62978 97.8981 4.43846 96.9049 3.4336C95.9116 2.42873 94.7295 1.63015 93.4265 1.08379C92.1236 0.537428 90.7254 0.254065 89.3125 0.25ZM90.1875 58.5313C90.1103 59.0091 89.8542 59.4397 89.4712 59.7357C89.0882 60.0317 88.6069 60.1709 88.125 60.125H80.3125C79.88 55.339 77.6731 50.8879 74.1254 47.6464C70.5778 44.4049 65.9461 42.6075 61.1406 42.6075C56.3351 42.6075 51.7034 44.4049 48.1558 47.6464C44.6082 50.8879 42.4013 55.339 41.9688 60.125H34.1563C33.6744 60.1709 33.1931 60.0317 32.81 59.7357C32.427 59.4397 32.1709 59.0091 32.0938 58.5313V11.6562C32.1637 11.175 32.418 10.7397 32.8028 10.4424C33.1876 10.145 33.6729 10.0088 34.1563 10.0625H88.125C88.6084 10.0088 89.0937 10.145 89.4785 10.4424C89.8633 10.7397 90.1175 11.175 90.1875 11.6562V58.5313Z" />
<path d="M19.0625 67.3125V21.25L8.28125 23.75C5.52227 24.3898 3.13004 26.0985 1.63004 28.5009C0.130032 30.9032 -0.355083 33.8027 0.28125 36.5625L12.9688 91.4688C13.6085 94.2277 15.3173 96.62 17.7196 98.12C20.122 99.62 23.0215 100.105 25.7813 99.4687L80.6875 86.7813C82.2073 86.4364 83.633 85.7623 84.8641 84.8067C86.0952 83.851 87.1016 82.6369 87.8125 81.25H32.9688C31.1399 81.25 29.3291 80.8893 27.6398 80.1885C25.9506 79.4877 24.4162 78.4605 23.1245 77.1659C21.8328 75.8713 20.8091 74.3346 20.1121 72.6438C19.4151 70.953 19.0584 69.1413 19.0625 67.3125ZM61.1563 22.5312C59.3502 22.5251 57.5829 23.055 56.0782 24.0539C54.5735 25.0528 53.399 26.4757 52.7036 28.1426C52.0082 29.8094 51.823 31.6451 52.1715 33.4172C52.5201 35.1893 53.3867 36.8182 54.6616 38.0975C55.9365 39.3767 57.5624 40.2489 59.3333 40.6036C61.1042 40.9582 62.9405 40.7793 64.6097 40.0896C66.2789 39.3999 67.7059 38.2303 68.71 36.7291C69.714 35.2278 70.25 33.4623 70.25 31.6562C70.25 29.2416 69.2929 26.9253 67.5884 25.2149C65.8839 23.5046 63.5709 22.5395 61.1563 22.5312Z" />
</g>
<defs>
<clipPath id="clip0_1_4">
<rect width="100" height="100" />
</clipPath>
</defs>
</svg>
`
let svg_callDefaultRoomUserPicIcon = `<svg width="90" height="100" viewBox="0 0 90 100"  xmlns="http://www.w3.org/2000/svg">
<path opacity="0.4" d="M44.9994 55.56C60.5321 55.56 73.124 43.1225 73.124 27.78C73.124 12.4375 60.5321 0 44.9994 0C29.4666 0 16.8748 12.4375 16.8748 27.78C16.8748 43.1225 29.4666 55.56 44.9994 55.56Z" />
<path d="M89.9499 83.379C89.9753 82.9836 89.9753 82.5872 89.9499 82.1918C89.8386 80.7306 89.424 79.3037 88.7293 77.9909C85.9953 72.6484 78.3302 70.2283 71.9344 68.8584C67.3713 67.9085 62.735 67.2978 58.0689 67.032L53.1866 66.6667H50.9896H48.2556H41.7134H38.9793H36.7823L31.9001 67.032C27.2339 67.2978 22.5976 67.9085 18.0345 68.8584C11.6388 70.0457 3.97364 72.5114 1.23959 77.9909C0.544908 79.3037 0.130334 80.7306 0.0190286 82.1918C-0.00634286 82.5872 -0.00634286 82.9836 0.0190286 83.379C-0.00439641 83.7744 -0.00439641 84.1708 0.0190286 84.5662C0.151826 86.0149 0.582864 87.4258 1.28841 88.7215C4.02247 94.0639 11.6876 96.484 18.0833 97.8539C22.6549 98.7594 27.2877 99.3696 31.9489 99.6804L36.8311 100H38.0029H39.0281H51.0384H52.0637H53.2354L58.1177 99.6804C62.7789 99.3696 67.4116 98.7594 71.9832 97.8539C78.379 96.621 86.0441 94.2009 88.7782 88.7215C89.4508 87.3848 89.8641 85.9469 89.9987 84.4749C90.0049 84.109 89.9886 83.7431 89.9499 83.379Z" />
</svg>
`
let svg_callLeftArrowIcon = `<svg width="50" height="100" viewBox="0 0 50 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M19.3369 49.7901L47.6724 16.1905C49.1632 14.4121 50 12.0065 50 9.49901C50 6.99151 49.1632 4.58589 47.6724 2.80755C46.9283 1.91793 46.043 1.21182 45.0676 0.729955C44.0922 0.248087 43.046 0 41.9893 0C40.9326 0 39.8864 0.248087 38.911 0.729955C37.9356 1.21182 37.0503 1.91793 36.3062 2.80755L2.36768 43.0512C1.61744 43.9336 1.02196 44.9833 0.615593 46.14C0.209222 47.2966 0 48.5372 0 49.7901C0 51.0431 0.209222 52.2837 0.615593 53.4403C1.02196 54.5969 1.61744 55.6467 2.36768 56.5291L36.3062 97.2473C37.0541 98.127 37.9411 98.8229 38.9164 99.2953C39.8916 99.7676 40.9359 100.007 41.9893 99.9998C43.0427 100.007 44.087 99.7676 45.0622 99.2953C46.0374 98.8229 46.9245 98.127 47.6724 97.2473C49.1632 95.469 50 93.0633 50 90.5558C50 88.0483 49.1632 85.6427 47.6724 83.8644L19.3369 49.7901Z" />
</svg>
`
let svg_callRightArrowIcon = `<svg width="50" height="100" viewBox="0 0 50 100"  xmlns="http://www.w3.org/2000/svg">
<path d="M47.6323 43.2565L13.6938 2.82094C12.9497 1.92708 12.0644 1.2176 11.089 0.733435C10.1136 0.24927 9.06738 0 8.01071 0C6.95404 0 5.90782 0.24927 4.93242 0.733435C3.95701 1.2176 3.07172 1.92708 2.32761 2.82094C0.836789 4.60776 0 7.02485 0 9.54431C0 12.0638 0.836789 14.4809 2.32761 16.2677L30.6631 50.0276L2.32761 83.7875C0.836789 85.5743 0 87.9914 0 90.5108C0 93.0303 0.836789 95.4474 2.32761 97.2342C3.07554 98.1181 3.96255 98.8174 4.93778 99.2919C5.91301 99.7665 6.95728 100.007 8.01071 99.9998C9.06414 100.007 10.1084 99.7665 11.0836 99.2919C12.0589 98.8174 12.9459 98.1181 13.6938 97.2342L47.6323 56.7986C48.3826 55.9121 48.978 54.8573 49.3844 53.6952C49.7908 52.533 50 51.2865 50 50.0276C50 48.7686 49.7908 47.5221 49.3844 46.36C48.978 45.1978 48.3826 44.1431 47.6323 43.2565Z" />
</svg>
`
const callMainContainer = document.getElementById("callMainContainer")
const beforeCallSection = document.getElementById("beforeCallSection")
const onCallSection = document.getElementById("onCallSection")
const onCallMainView = document.getElementById("onCallMainView")
const onCallUserBoxSlider = document.getElementById("onCallUserBoxSlider")
const onCallCallStatus = document.getElementById("onCallCallStatus")
const onCallMainBtnContainer = document.getElementById("onCallMainBtnContainer")

let myMediaStream = null
let myPeer
let allMediaConnections = {}

import { v4 as uuidv4 } from "uuid"
import { Peer } from "peerjs"

export async function createOnCallSection(callRoom) {
  beforeCallSection.classList.add("before-call-section--hide")

  let onCallMainViewHtml = `
  <div class="on-call-btn on-call-btn--unselected on-call-btn--room-info ">
         <div class="on-call-btn__icon on-call-btn__icon--unselected on-call-btn__icon--selected">
               ${svg_callRoomInfoIcon}
         </div>
  </div>
  
  <div class="on-call-btn on-call-btn--view-change on-call-btn--unselected ">
        <div class="on-call-btn__icon on-call-btn__icon--unselected">
             ${svg_callSwitchViewToMultipleIcon}
        </div>
        <div class="on-call-btn__icon on-call-btn__icon--selected">
              ${svg_callSwitchViewToSingleIcon}
         </div>
  </div>
`
  onCallMainView.insertAdjacentHTML("beforeend", onCallMainViewHtml)

  let onCallUserBoxSliderHtml = `
     <div class="on-call-user-box-slider-btn on-call-user-box-slider-btn--selected">
           <div class="on-call-user-box-slider-btn__icon on-call-user-box-slider-btn__icon--unselected">
                     ${svg_callLeftArrowIcon}
           </div>
           <div class="on-call-user-box-slider-btn__icon on-call-user-box-slider-btn__icon--selected">
                     ${svg_callRightArrowIcon}
           </div>
     </div>
`
  onCallUserBoxSlider.insertAdjacentHTML("beforeend", onCallUserBoxSliderHtml)

  //   for (let i = 0; i < callRoom.members.length; i++) {
  //     let onCallUserBox = createOnCallUserBox(callRoom.members[i])
  //     onCallMainView.insertAdjacentElement("afterbegin", onCallUserBox)
  //   }
  //   switchViewToSingle()

  let onCallMainBtnContainerHtml
  if (callRoom.isChatRoom) {
    if (callRoom.roomChat.isGroupChat) {
      let { groupChatCallBtns } = await import("./onCallSectionBtns.dev")
      onCallMainBtnContainerHtml = groupChatCallBtns
    } else {
      let { nonGroupChatCallRoomBtns } = await import("./onCallSectionBtns.dev")
      onCallMainBtnContainerHtml = nonGroupChatCallRoomBtns
    }
  } else {
    let { nonChatCallRoomBtns } = await import("./onCallSectionBtns.dev")
    onCallMainBtnContainerHtml = nonChatCallRoomBtns
  }
  onCallMainBtnContainer.insertAdjacentHTML(
    "beforeend",
    onCallMainBtnContainerHtml
  )
  showOnCallCallStatus(callRoom)

  onCallSection.classList.remove("on-call-section--hide")

  if (callRoom.hasOwnProperty("joinedMember")) {
    let onCallUserBox = createOnCallUserBox(callRoom.joinedMember)
    onCallUserBoxSlider.insertAdjacentElement("afterbegin", onCallUserBox)
  }

  await initialiseCall(callRoom)
  //   initialiseEventForOnCallSection()
}
async function initialiseCall(callRoom) {
  try {
    myPeer = new Peer(uuidv4(), { debug: 0 })

    fetch("/call-room-member/update-peer-id", {
      method: "Put", // or 'PUT'
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        userId: loginUser._id.toString(),
        callRoomId: callRoom._id.toString(),
        peerId: myPeer.id
      })
    })
      .then(response => {
        if (response.ok) {
          return response.json()
        }
        return Promise.reject(response)
      })
      .then(async data => {
        if (data.isSuccess) {
          implementCall(callRoom)
        } else {
          let { createMainNotification } = await import(
            "../../common/mainNotification.dev"
          )
          createMainNotification(data.error, "error")
        }
      })
      .catch(async err => {
        console.log(err)
        let { createMainNotification } = await import(
          "../../common/mainNotification.dev"
        )
        createMainNotification(
          "Server error in updating peer,please refresh your page",
          "error"
        )
      })
  } catch (e) {
    console.log("error in calling:", e)
  }
}

async function implementCall(callRoom) {
  navigator.mediaDevices
    .getUserMedia({
      video: true,
      audio: true
    })
    .then(stream => {
      myMediaStream = stream

      addStreamToOnCallUserBox(loginUser._id.toString(), myMediaStream)

      myPeer.on("call", mediaConnection => {
        mediaConnection.answer(myMediaStream)
        mediaConnection.once("stream", otherMediaStream => {
          fetchCallRoomMemberAndCreateUserBoxWithStream(
            mediaConnection.peer,
            callRoom._id,
            otherMediaStream
          )
        })
      })
    })
    .catch(e => {
      console.log("Error in accessing your camera and mic:", e.message)
    })

  myPeer.on("open", id => {
    let eventData = {
      callRoomId: callRoom._id,
      userId: loginUser._id,
      peerId: myPeer.id
    }
    socket.emit("call:join-call-room", eventData)
  })

  myPeer.on("error", err => {
    console.log("Error in peer: ", err.type)
  })

  socket.on("call:joined-new-member", data => {
    connectToNewJoinedMember(data.userId, data.peerId, callRoom, myMediaStream)
  })

  socket.on("call:disconnect-call-member", data => {
    removeOnCallUserBox(data.userId)
  })
}

function connectToNewJoinedMember(
  otherUserId,
  otherPeerId,
  callRoom,
  myStream
) {
  const mediaConnection = myPeer.call(otherPeerId, myStream, {
    metadata: { userId: loginUser._id.toString(), callRoomId: callRoom._id }
  })

  mediaConnection.once("stream", otherMediaStream => {
    fetchCallRoomMemberAndCreateUserBoxWithStream(
      mediaConnection.peer,
      callRoom._id,
      otherMediaStream
    )
  })

  mediaConnection.on("close", () => {
    removeOnCallUserBox(otherUserId)
  })

  mediaConnection.on("error", function (err) {
    console.log("Error in media connection:", err.type)
  })

  allMediaConnections[otherPeerId] = mediaConnection
}

function fetchCallRoomMemberAndCreateUserBoxWithStream(
  peerId,
  callRoomId,
  stream
) {
  fetch("/call-room-member/data/member", {
    method: "POST", // or 'PUT'
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      peerId: peerId,
      callRoomId: callRoomId
    })
  })
    .then(response => {
      if (response.ok) {
        return response.json()
      }
      return Promise.reject(response)
    })
    .then(async data => {
      if (data.isSuccess) {
        let onCallUserBox = createOnCallUserBox(data.callRoomMember)

        if (onCallSection.dataset.callViewType === "single") {
          onCallUserBoxSlider.insertAdjacentElement("afterbegin", onCallUserBox)
        } else if (onCallSection.dataset.callViewType === "multiple") {
          onCallMainView.insertAdjacentElement("afterbegin", onCallUserBox)
          changeHeightAndWidthOfOnCallUserBoxInMainView()
        }

        addStreamToOnCallUserBox(data.callRoomMember.user._id, stream)
      } else {
        let { createMainNotification } = await import(
          "../../common/mainNotification.dev"
        )
        createMainNotification(data.error, "error")
      }
    })
    .catch(async err => {
      console.log(err)
      let { createMainNotification } = await import(
        "../../common/mainNotification.dev"
      )
      createMainNotification(
        "Server error in fetching room member,please refresh your page",
        "error"
      )
    })
}

function addStreamToOnCallUserBox(userId, stream) {
  let onCallUserBox = document.querySelector(
    `.on-call-user-box[data-user-id="${userId}"]`
  )
  let video = document.createElement("video")
  video.muted = true

  video.srcObject = stream
  video.addEventListener("loadedmetadata", () => {
    video.play()
  })

  onCallUserBox
    .getElementsByClassName("on-call-user-box__video")[0]
    .insertAdjacentElement("beforeend", video)
}

function createOnCallUserBox(member) {
  let onCallUserBox = document.createElement("div")
  onCallUserBox.classList.add("on-call-user-box")
  onCallUserBox.dataset.userId = member.user._id
  let onCallUserBoxHtml = `<div class="on-call-user-box__video">
                        </div>

          <div class="on-call-user-box__audio">
             <div class="on-call-user-box__audio-icon on-call-user-box__audio-icon--on">
               ${svg_callAudioOnIcon}
             </div>
             <div class="on-call-user-box__audio-icon on-call-user-box__audio-icon--off">
               ${svg_callAudioOffIcon}
             </div>
         </div>

  <div class="on-call-user-box__info">

     <div class='on-call-user-box__pic ${
       member.user.hasOwnProperty("profile") && member.user.profile !== ""
         ? "on-call-user-box__pic--img"
         : "on-call-user-box__pic--svg"
     }'>

         ${svg_callDefaultRoomUserPicIcon}
         <img src='${
           member.user.hasOwnProperty("profile") && member.user.profile !== ""
             ? member.user.profile
             : ""
         }' alt="">
          
     </div>
     <div class="on-call-user-box__name"></div>

  </div>`

  onCallUserBox.insertAdjacentHTML("beforeend", onCallUserBoxHtml)
  let name
  if (member._id.toString() === loginUser._id.toString()) {
    name = "(You)"
  } else {
    name = member.user.firstName + " " + member.user.lastName
  }
  onCallUserBox.getElementsByClassName(
    "on-call-user-box__name"
  )[0].textContent = name

  if (member.isAudioOn) {
    onCallUserBox
      .getElementsByClassName("on-call-user-box__audio")[0]
      .classList.add("on-call-user-box__audio--on")
  } else {
    onCallUserBox
      .getElementsByClassName("on-call-user-box__audio")[0]
      .classList.add("on-call-user-box__audio--off")
  }
  if (!member.isVideoOn) {
    onCallUserBox.classList.add("on-call-user-box--video-off")
  }

  return onCallUserBox
}

function removeOnCallUserBox(userId) {
  let onCallUserBoxs = [
    ...document.querySelectorAll(`.on-call-user-box[data-user-id="${userId}"]`)
  ]
  onCallUserBoxs.forEach(userBox => {
    console.log(userBox)
    userBox.remove()
  })

  //   changeHeightAndWidthOfOnCallUserBoxInMainView()
}

function showOnCallCallStatus(callRoom) {
  onCallCallStatus.innerHTML = `
        <div class='on-call-call-status__room-pic ${
          callRoom.hasOwnProperty("roomPic") && callRoom.roomPic !== ""
            ? "on-call-call-status__room-pic--img"
            : "on-call-call-status__room-pic--svg"
        }'>
      
            ${svg_callDefaultRoomPicIcon}
              <img src='${
                callRoom.hasOwnProperty("roomPic") && callRoom.roomPic !== ""
                  ? callRoom.roomPic
                  : ""
              }'
             alt="">
         </div>
         
         <div class="on-call-call-status__room-status">
         </div>
      `
  let roomStatus = callRoom.roomStatus
  if (roomStatus === "waiting") {
    roomStatus = "waiting for others to join"
  }
  onCallCallStatus.getElementsByClassName(
    "on-call-call-status__room-status"
  )[0].textContent = roomStatus

  onCallCallStatus
    .getElementsByClassName("on-call-call-status__room-status")[0]
    .insertAdjacentHTML(
      "beforeend",
      `<span class="on-call-call-status__room-status-effect">.</span><span class="on-call-call-status__room-status-effect">.</span><span class="on-call-call-status__room-status-effect">.</span>`
    )
  onCallCallStatus.classList.remove("on-call-call-status--hide")
}

function changeHeightAndWidthOfOnCallUserBoxInMainView() {
  let onCallUserBoxs = [
    ...onCallMainView.getElementsByClassName("on-call-user-box")
  ]
  let noOfUsers = onCallUserBoxs.length
  let devider = Math.ceil(Math.sqrt(noOfUsers))
  let percent = 100 / devider - 1

  onCallUserBoxs.forEach(userBox => {
    userBox.style.height = percent + "%"
    userBox.style.width = percent + "%"
  })
}

function resetHeightAndWidthOfOnCallUserBox() {
  let onCallUserBoxs = [...document.getElementsByClassName("on-call-user-box")]

  onCallUserBoxs.forEach(userBox => {
    userBox.style = ""
  })
}
function switchViewToSingle() {
  let onCallUserBoxs = [
    ...onCallMainView.getElementsByClassName("on-call-user-box")
  ]

  let noOfOnCallUserBoxs = onCallUserBoxs.length

  if (noOfOnCallUserBoxs > 1) {
    for (let i = 1; i < onCallUserBoxs.length; i++) {
      onCallUserBoxs[0].classList.add("on-call-user-box--change-info")
      onCallUserBoxSlider.appendChild(onCallUserBoxs[i])
    }
  } else if (noOfOnCallUserBoxs === 1) {
    onCallUserBoxSlider.appendChild(onCallUserBoxs[0])
    onCallCallStatus.classList.remove("on-call-call-status--hide")
  } else {
    onCallCallStatus.classList.remove("on-call-call-status--hide")
  }

  resetHeightAndWidthOfOnCallUserBox()

  let switchCallViewBtn = onCallMainView.querySelector(
    '.on-call-btn[data-btn-type="switch-call-view"]'
  )
  if (switchCallViewBtn) {
    switchCallViewBtn.classList.add("on-call-btn--unselected")
    switchCallViewBtn.classList.remove("on-call-btn--selected")
  }
  onCallSection.dataset.callViewType = "single"
}

function switchViewToMultiple() {
  onCallCallStatus.classList.add("on-call-call-status--hide")

  let onCallUserBoxs = [
    ...onCallUserBoxSlider.getElementsByClassName("on-call-user-box")
  ]

  for (let i = 0; i < onCallUserBoxs.length; i++) {
    onCallMainView.appendChild(onCallUserBoxs[i])
  }

  changeHeightAndWidthOfOnCallUserBoxInMainView()

  let switchCallViewBtn = onCallMainView.querySelector(
    '.on-call-btn[data-btn-type="switch-call-view"]'
  )
  if (switchCallViewBtn) {
    switchCallViewBtn.classList.remove("on-call-btn--unselected")
    switchCallViewBtn.classList.add("on-call-btn--selected")
  }
  onCallSection.dataset.callViewType = "multiple"
}
function initialiseEventForOnCallSection() {
  onCallMainBtnContainer.addEventListener("click", async e => {
    let onCallBtn = e.target.closest(`.on-call-btn`)
    if (onCallBtn && onCallMainBtnContainer.contains(onCallBtn)) {
      console.log("clicked btn")
      //   if (onCallBtn.dataset.btnType === "video") {
      //     if (myMediaStream !== null) {
      //       let videoEnabled = myMediaStream.getVideoTracks()[0].enabled
      //       if (videoEnabled) {
      //         myMediaStream.getVideoTracks()[0].enabled = false
      //         calltypeInfoBtn.classList.add("calltype-info-btn--selected")
      //         calltypeInfoBtn.classList.remove("calltype-info-btn--unselected")
      //         calltypeInfoPreview.classList.add(
      //           "calltype-info__preview--video-off"
      //         )
      //         calltypeInfoBtn.dataset.calltypeVideoValue = "false"
      //       } else {
      //         myMediaStream.getVideoTracks()[0].enabled = true
      //         calltypeInfoBtn.classList.remove("calltype-info-btn--selected")
      //         calltypeInfoBtn.classList.add("calltype-info-btn--unselected")
      //         calltypeInfoPreview.classList.remove(
      //           "calltype-info__preview--video-off"
      //         )
      //         calltypeInfoBtn.dataset.calltypeVideoValue = "true"
      //       }
      //     }
      //   }
      //   if (calltypeInfoBtn.dataset.calltypeInfoBtn === "audio") {
      //     if (myMediaStream !== null) {
      //       let audioEnabled = myMediaStream.getAudioTracks()[0].enabled
      //       if (audioEnabled) {
      //         myMediaStream.getAudioTracks()[0].enabled = false
      //         calltypeInfoBtn.classList.add("calltype-info-btn--selected")
      //         calltypeInfoBtn.classList.remove("calltype-info-btn--unselected")
      //         calltypeInfoPreview.classList.add(
      //           "calltype-info__preview--audio-off"
      //         )
      //         calltypeInfoBtn.dataset.calltypeAudioValue = "false"
      //       } else {
      //         myMediaStream.getAudioTracks()[0].enabled = true
      //         calltypeInfoBtn.classList.remove("calltype-info-btn--selected")
      //         calltypeInfoBtn.classList.add("calltype-info-btn--unselected")
      //         calltypeInfoPreview.classList.remove(
      //           "calltype-info__preview--audio-off"
      //         )
      //         calltypeInfoBtn.dataset.calltypeAudioValue = "true"
      //       }
      //     }
      //   }
    }
  })
}
