let svg_addAvatar = `<svg width="102" height="102" viewBox="0 0 102 102"  xmlns="http://www.w3.org/2000/svg">
<path d="M25.2853 1C18.8469 1.00815 12.6746 3.55954 8.12202 8.09461C3.56942 12.6297 1.00818 18.7782 1 25.1918V69.1727C1.00818 75.5863 3.56942 81.7348 8.12202 86.2699C12.6746 90.805 18.8469 93.3564 25.2853 93.3645H57.7609C56.5955 90.9311 55.8062 88.336 55.4197 85.6675H25.2853C22.5191 85.6675 19.9383 84.9286 17.6435 83.7278C19.0047 79.5413 21.2538 75.6953 24.2384 72.4508C27.223 69.2063 30.8731 66.6392 34.9413 64.9236C39.0094 63.208 43.4003 62.3841 47.8163 62.5076C52.2322 62.6312 56.5698 63.6994 60.5348 65.6398C63.0317 62.2915 66.2785 59.5697 70.0169 57.691C73.7553 55.8123 77.8822 54.8285 82.0694 54.8177C86.2573 54.8177 90.1825 55.8568 93.7214 57.5425V25.1918C93.7132 18.7782 91.1519 12.6297 86.5993 8.09461C82.0467 3.55954 75.8744 1.00815 69.4361 1H25.2853ZM47.237 23.8833C50.2347 23.8848 53.1647 24.7716 55.6566 26.4316C58.1484 28.0916 60.0903 30.4502 61.2368 33.2093C62.3832 35.9685 62.6828 39.0043 62.0976 41.933C61.5124 44.8617 60.0687 47.5518 57.949 49.6634C55.8293 51.7749 53.1288 53.213 50.1888 53.796C47.2488 54.3789 44.2012 54.0805 41.4314 52.9384C38.6616 51.7964 36.2939 49.862 34.6275 47.3797C32.9611 44.8974 32.0709 41.9788 32.0694 38.9926C32.0694 30.6644 38.8767 23.8833 47.237 23.8833ZM82.0694 62.5225C79.4877 62.4497 76.9176 62.8934 74.511 63.8273C72.1045 64.7612 69.9104 66.1664 68.0584 67.9597C66.2065 69.7531 64.7345 71.8981 63.7292 74.268C62.724 76.6379 62.2061 79.1846 62.2061 81.7574C62.2061 84.3302 62.724 86.8768 63.7292 89.2467C64.7345 91.6167 66.2065 93.7617 68.0584 95.555C69.9104 97.3483 72.1045 98.7535 74.511 99.6874C76.9176 100.621 79.4877 101.065 82.0694 100.992C87.1246 100.892 91.9387 98.8204 95.4781 95.2234C99.0175 91.6264 101 86.7903 101 81.7535C101 76.7167 99.0175 71.8807 95.4781 68.2837C91.9387 64.6867 87.1246 62.6155 82.0694 62.5148V62.5225ZM78.0514 70.2195H85.7782V77.8935H93.4973V85.5905H85.7859V93.2568H78.0592V85.5905H70.3633V77.8935H78.0592V70.2118L78.0514 70.2195Z" />
</svg>`
let svg_addUserBtn = `<svg width="102" height="102" viewBox="0 0 102 102"  xmlns="http://www.w3.org/2000/svg">
<path d="M68.8571 36.7143C86.6093 36.7143 101 51.1051 101 68.8571C101 86.6093 86.6093 101 68.8571 101C51.1051 101 36.7143 86.6093 36.7143 68.8571C36.7143 51.1051 51.1051 36.7143 68.8571 36.7143ZM68.8571 51C66.885 51 65.2857 52.599 65.2857 54.5714V65.2857H54.5714C52.599 65.2857 51 66.885 51 68.8571C51 70.8293 52.599 72.4286 54.5714 72.4286H65.2857V83.1429C65.2857 85.115 66.885 86.7143 68.8571 86.7143C70.8293 86.7143 72.4286 85.115 72.4286 83.1429V72.4286H83.1429C85.115 72.4286 86.7143 70.8293 86.7143 68.8571C86.7143 66.885 85.115 65.2857 83.1429 65.2857H72.4286V54.5714C72.4286 52.599 70.8293 51 68.8571 51ZM38.5511 43.8571C32.9416 50.6496 29.5714 59.36 29.5714 68.8571C29.5714 72.5714 30.0868 76.165 31.0499 79.57L30.0014 79.5771C11.9477 79.5771 1.69762 73.544 1.03434 61.3841L1 60.1043V54.5714C1 49.0022 5.24918 44.4254 10.6824 43.9062L11.7143 43.8571H38.5511ZM29.5714 1C39.4353 1 47.4315 8.99622 47.4315 18.86C47.4315 28.7239 39.4353 36.7201 29.5714 36.7201C19.7076 36.7201 11.7114 28.7239 11.7114 18.86C11.7114 8.99622 19.7076 1 29.5714 1ZM65.2857 8.14286C73.1757 8.14286 79.5714 14.5388 79.5714 22.4286C79.5714 25.398 78.6657 28.1559 77.115 30.4408C74.4521 29.8712 71.69 29.5714 68.8571 29.5714C63.9114 29.5714 59.18 30.4852 54.8208 32.1532C52.45 29.6031 51 26.1851 51 22.4286C51 14.5388 57.3959 8.14286 65.2857 8.14286Z"  />
</svg>
`

import "../css/groupChatFormModal.dev.css"

import Uppy from "@uppy/core"
import Dashboard from "@uppy/dashboard"
import Webcam from "@uppy/webcam"
import ImageEditor from "@uppy/image-editor"

import "@uppy/core/dist/style.css"
import "@uppy/dashboard/dist/style.css"
import "@uppy/webcam/dist/style.css"
import "@uppy/image-editor/dist/style.css"

import AwsS3Multipart from "@uppy/aws-s3-multipart"

let groupChatFormData = {
  chatId: "",
  chatPic: "",
  chatName: "",
  chatDesc: "",
  chatUsers: []
}
export async function createGroupChatFormModal(modalType = "new") {
  const chatMainContainer = document.getElementById("chatMainContainer")
  let groupChatFormModal = document.getElementById("groupChatFormModal")
  if (!groupChatFormModal) {
    groupChatFormModal = document.createElement("div")
    groupChatFormModal.classList.add("chat-modal")
    groupChatFormModal.setAttribute("id", "groupChatFormModal")

    let groupChatFormModalHtml = `<div class="chat-modal-content chat-modal-content--group-chat-form">
    <div class="group-chat-form-header">
        <div class="group-chat-form-header__title"></div>

    </div>
    <div class="chat-modal-content-row">

        <div class="group-chat-form-pic group-chat-form-pic--hide-img" id="groupChatFormPic" data-chat-pic="" >
        <img src="" alt="group chat pic">
            ${svg_addAvatar}
        </div>
        <div class="group-chat-form-name">
            <input type="text" placeholder="Title..." id="groupChatFormName">
        </div>
    </div>
    <div class="group-chat-form-desc">
        <textarea placeholder='Description...' id="groupChatFormDesc"></textarea>
    </div>
    <div class="group-chat-form-add-user">
        <div class="chat-modal-content-row chat-modal-content-row--group-chat-form-add-user">
            <div class="group-chat-form-add-user__title">
                Add user:
            </div>
            <div class="group-chat-form-add-user__count">
                0/10
            </div>
        </div>
        <div class="chat-modal-content-row" id='addUserToGroupChatFormBtn'>
            <div class="group-chat-form-add-user__btn" >
                ${svg_addUserBtn}
            </div>
            <div class="group-chat-form-add-user__info">Select more than 1 user.</div>

        </div>
    </div>
    <div class="group-chat-form-added-user-container">
        
    
    </div>
    <div class="group-chat-form-btn-container">
        <div class="group-chat-form-btn-container__btn" id="closeGroupChatFormModalBtn">Cancle</div>
        <div class="group-chat-form-btn-container__btn group-chat-form-btn-container__btn--active" id="submitGroupChatDataBtn"></div>
    </div>
    </div>`

    groupChatFormModal.insertAdjacentHTML("beforeend", groupChatFormModalHtml)

    chatMainContainer.insertAdjacentElement("beforeend", groupChatFormModal)

    // initialise Event to group chat form Modal

    document
      .getElementById("addUserToGroupChatFormBtn")
      .addEventListener("click", async () => {
        let { createAddUserModal } = await import("./createAddUserModal.dev")
        //send callback function to createAddUserModal so that it can call it change the groupChatFormData.chatUsers array
        createAddUserModal(
          groupChatFormData.chatUsers,
          updateGroupChatFormModalUsers
        )
      })

    document
      .getElementById("submitGroupChatDataBtn")
      .addEventListener("click", async () => {
        if (
          groupChatFormData.chatUsers.length >= 2 &&
          groupChatFormData.chatUsers.length <= 10
        ) {
          groupChatFormData.chatName = document
            .getElementById("groupChatFormName")
            .value.trim()
          groupChatFormData.chatDesc = document
            .getElementById("groupChatFormDesc")
            .value.trim()
          groupChatFormData.chatPic =
            document.getElementById("groupChatFormPic").dataset.chatPic
          if (groupChatFormData.chatName !== "") {
            let newGroupChatData = {}

            newGroupChatData.chatId = groupChatFormData.chatId

            newGroupChatData.chatName = groupChatFormData.chatName

            newGroupChatData.chatDesc = groupChatFormData.chatDesc

            newGroupChatData.chatPic = groupChatFormData.chatPic

            newGroupChatData.chatUserIds = groupChatFormData.chatUsers.map(
              user => user._id
            )

            if (modalType === "new") {
              fetch("/chat/create-new-group-chat", {
                method: "POST", // or 'PUT'
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(newGroupChatData)
              })
                .then(response => {
                  if (response.ok) {
                    return response.json()
                  }
                  return Promise.reject(response)
                })
                .then(async data => {
                  if (data.isSuccess) {
                    updateGroupChatFormModalData()
                    groupChatFormModal.classList.add("chat-modal--hide")

                    let { createChatBox } = await import(
                      "./updateAllChatSection.dev"
                    )
                    createChatBox(data.chat)
                  } else {
                    let { createMainNotification } = await import(
                      "../../common/mainNotification.dev"
                    )
                    createMainNotification(data.error, "error")
                  }
                })
                .catch(async err => {
                  console.log(err)
                  let { createMainNotification } = await import(
                    "../../common/mainNotification.dev"
                  )
                  createMainNotification(
                    "Server Error In Creating New Group Chat, Please Check Your Input",
                    "error"
                  )
                })
            }
            if (modalType === "edit") {
              fetch("/chat/edit-group-chat", {
                method: "POST", // or 'PUT'
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(newGroupChatData)
              })
                .then(response => {
                  if (response.ok) {
                    return response.json()
                  }
                  return Promise.reject(response)
                })
                .then(async data => {
                  if (data.isSuccess) {
                    console.log(data)
                    activeChatData = { ...data.chat }
                    let { updateActiveChatInfoModal } = await import(
                      "./createActiveChatInfoModal.dev"
                    )
                    let { updateActiveChatSection } = await import(
                      "./showActiveChatSection.dev"
                    )
                    let { updateChatBox } = await import(
                      "./updateAllChatSection.dev"
                    )

                    updateActiveChatInfoModal()
                    updateActiveChatSection(activeChatData)
                    updateChatBox(activeChatData)

                    groupChatFormModal.classList.add("chat-modal--hide")
                  } else {
                    let { createMainNotification } = await import(
                      "../../common/mainNotification.dev"
                    )
                    createMainNotification(data.error, "error")
                  }
                })
                .catch(async err => {
                  console.log(err)
                  let { createMainNotification } = await import(
                    "../../common/mainNotification.dev"
                  )
                  createMainNotification(
                    "Server Error In Editing Group Chat, Please Check Your Input",
                    "error"
                  )
                })
            }
          } else {
            let { createMainNotification } = await import(
              "../../common/mainNotification.dev"
            )
            createMainNotification("Please Fill Your Group Name Field", "error")
          }
        } else if (groupChatFormData.chatUsers.length > 10) {
          let { createMainNotification } = await import(
            "../../common/mainNotification.dev"
          )
          createMainNotification(
            "Sorry,You Can Only Select Up To 10 Members",
            "error"
          )
        } else {
          let { createMainNotification } = await import(
            "../../common/mainNotification.dev"
          )
          createMainNotification("Please Select Atleast 2 Members", "error")
        }
      })

    // close group chat modal
    document
      .getElementById("closeGroupChatFormModalBtn")
      .addEventListener("click", () => {
        groupChatFormModal.classList.add("chat-modal--hide")
      })
    window.addEventListener("click", event => {
      if (event.target === groupChatFormModal) {
        groupChatFormModal.classList.add("chat-modal--hide")
      }
    })

    const uppy = new Uppy({
      id: "groupChatForm",
      autoProceed: false,
      allowMultipleUploadBatches: false,
      debug: false,
      onBeforeFileAdded: (currentFile, files) => {
        if (!currentFile.type) {
          uppy.log(`Skipping file because it has no type`)
          uppy.info(`Skipping file because it has no type`, "error", 500)
          return false
        } else {
          let groupChatFormPicKey =
            document.getElementById("groupChatFormPic").dataset.chatPic
          currentFile.name = groupChatFormPicKey
          return currentFile
        }
      },
      onBeforeUpload: files => {
        // const updatedFiles = {}
        // Object.keys(files).forEach(fileID => {
        //   updatedFiles[fileID] = {
        //     ...files[fileID],
        //     meta: {
        //       ...files[fileID].meta,
        //       fileType: files[fileID].type
        //     }
        //   }
        // })
        // console.log(updatedFiles)
        // return updatedFiles
      },
      restrictions: {
        maxFileSize: 1024 * 1024 * 5,
        minFileSize: null,
        maxTotalFileSize: 1024 * 1024 * 5 * 1,
        maxNumberOfFiles: 1,
        minNumberOfFiles: 1,
        allowedFileTypes: [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/svg+xml",
          "image/x-png"
        ]
      },
      meta: { mediaType: "group-chat-pic" },
      infoTimeout: 5000
    })
      .use(Dashboard, {
        trigger: "#groupChatFormPic",
        target: "body",
        inline: false,
        plugins: ["Webcam", "ImageEditor"],
        thumbnailWidth: 300,
        // closeAfterFinish: false,
        showRemoveButtonAfterComplete: false,
        disablePageScrollWhenModalOpen: true,
        closeModalOnClickOutside: true,

        theme: "light",
        locale: {
          strings: {}
        },
        note: "File size up to 5 MB",
        proudlyDisplayPoweredByUppy: false
      })
      .use(Webcam, {
        target: Dashboard,
        title: "Camera",
        mirror: true,
        modes: ["picture"]
      })
      .use(ImageEditor, {
        target: Dashboard,
        quality: 0.8
      })

      .use(AwsS3Multipart, {
        limit: 4,
        companionUrl: "http://localhost:5000/companion"
      })

    // uppy.on("complete", result => {
    //   console.log(
    //     "Upload complete! Weâ€™ve uploaded these files:",
    //     result.successful
    //   )
    // })
    uppy.on("upload-success", (file, response) => {
      let groupChatFormPic = document.getElementById("groupChatFormPic")
      groupChatFormPic.classList.add("group-chat-form-pic--hide-svg")
      groupChatFormPic.classList.remove("group-chat-form-pic--hide-img")

      groupChatFormPic.dataset.chatPic = file.s3Multipart.key

      let groupChatFormPicImg = groupChatFormPic.querySelector("img")
      if (groupChatFormPicImg) {
        groupChatFormPicImg.src = file.preview
      }
    })
  } else {
    groupChatFormModal.classList.remove("chat-modal--hide")
  }
  updateGroupChatFormModal(groupChatFormModal, modalType)
}

export function updateGroupChatFormModal(
  groupChatFormModal,
  modalType = "new"
) {
  groupChatFormModal.getElementsByClassName(
    "group-chat-form-header__title"
  )[0].textContent = modalType === "new" ? "Create Group" : "Edit Group"
  document.getElementById("submitGroupChatDataBtn").textContent =
    modalType === "new" ? "Create Group" : "Edit Group"
}

export function updateGroupChatFormAddedUserContainer(
  groupChatFormModal,
  users
) {
  let groupChatFormAddedUserContainer =
    groupChatFormModal.getElementsByClassName(
      "group-chat-form-added-user-container"
    )[0]
  groupChatFormModal.getElementsByClassName(
    "group-chat-form-add-user__count"
  )[0].textContent = users.length + "/" + "10"

  if (users.length >= 2) {
    document
      .getElementsByClassName("group-chat-form-add-user__info")[0]
      .classList.add("group-chat-form-add-user__info--hide")
  } else {
    document
      .getElementsByClassName("group-chat-form-add-user__info")[0]
      .classList.remove("group-chat-form-add-user__info--hide")
  }

  groupChatFormAddedUserContainer.innerHTML = ""
  users.forEach(user => {
    createGroupChatFormAddedUser(
      groupChatFormModal,
      groupChatFormAddedUserContainer,
      user
    )
  })
}

export function createGroupChatFormAddedUser(
  groupChatFormModal,
  groupChatFormAddedUserContainer,
  user
) {
  let addedUser = document.createElement("div")
  addedUser.classList.add("group-chat-form-added-user")
  addedUser.dataset.userId = user._id
  let addedUserHtml = `
<span class="group-chat-form-added-user__username"></span>
<span class="group-chat-form-added-user__remove">X</span>`

  addedUser.insertAdjacentHTML("beforeend", addedUserHtml)
  groupChatFormAddedUserContainer.insertAdjacentElement("beforeend", addedUser)

  addedUser.getElementsByClassName(
    "group-chat-form-added-user__username"
  )[0].textContent = user.username
  addedUser
    .getElementsByClassName("group-chat-form-added-user__remove")[0]
    .addEventListener("click", () => {
      let userId = addedUser.dataset.userId
      groupChatFormData.chatUsers = groupChatFormData.chatUsers.filter(
        user => user._id !== userId
      )
      if (groupChatFormData.chatUsers.length > 1) {
        document
          .getElementsByClassName("group-chat-form-add-user__info")[0]
          .classList.add("group-chat-form-add-user__info--hide")
      } else {
        document
          .getElementsByClassName("group-chat-form-add-user__info")[0]
          .classList.remove("group-chat-form-add-user__info--hide")
      }
      addedUser.parentNode.removeChild(addedUser)

      let addedUserCount = groupChatFormModal.getElementsByClassName(
        "group-chat-form-add-user__count"
      )[0]

      addedUserCount.textContent =
        parseFloat(
          addedUserCount.textContent.slice(
            0,
            addedUserCount.textContent.indexOf("/")
          )
        ) -
        1 +
        "/" +
        10
    })
}

export function updateGroupChatFormModalData(groupChat) {
  let groupChatFormPic = document.getElementById("groupChatFormPic")

  if (groupChat && groupChat.isGroupChat === true) {
    groupChatFormData.chatId = groupChat._id
    groupChatFormData.chatName = groupChat.chatName
    groupChatFormData.chatDesc = groupChat.chatDescription
    if (groupChat.hasOwnProperty("chatPic") && groupChat.chatPic !== "") {
      let initialStartPos = groupChat.chatPic.indexOf(".com")
      let startPos = groupChat.chatPic.indexOf(
        "group-chat-pic",
        initialStartPos
      )
      let lastPos = groupChat.chatPic.indexOf("?", startPos)

      groupChatFormData.chatPic = groupChat.chatPic.slice(startPos, lastPos)

      groupChatFormPic.querySelector("img").src = groupChat.chatPic
    } else {
      groupChatFormData.chatPic = ""
    }
    groupChatFormData.chatUsers = groupChat.currentChatMembers.filter(user => {
      return user._id !== loginUser._id
    })
  } else {
    groupChatFormData.chatId = ""
    groupChatFormData.chatName = ""
    groupChatFormData.chatDesc = ""
    groupChatFormData.chatPic = ""
    groupChatFormData.chatUsers = []
  }

  document.getElementById("groupChatFormName").value =
    groupChatFormData.chatName
  document.getElementById("groupChatFormDesc").value =
    groupChatFormData.chatDesc

  if (groupChatFormData.chatPic === "") {
    groupChatFormPic.classList.remove("group-chat-form-pic--hide-svg")
    groupChatFormPic.classList.add("group-chat-form-pic--hide-img")
    groupChatFormPic.dataset.chatPic = ""
  } else {
    groupChatFormPic.classList.remove("group-chat-form-pic--hide-img")
    groupChatFormPic.classList.add("group-chat-form-pic--hide-svg")
    groupChatFormPic.dataset.chatPic = groupChatFormData.chatPic
  }
  let groupChatFormModal = document.getElementById("groupChatFormModal")
  // send the groupChatFormData.chatUsers array reference
  updateGroupChatFormAddedUserContainer(
    groupChatFormModal,
    groupChatFormData.chatUsers
  )
}
export function updateGroupChatFormModalUsers(users) {
  groupChatFormData.chatUsers = users
  let groupChatFormModal = document.getElementById("groupChatFormModal")
  updateGroupChatFormAddedUserContainer(
    groupChatFormModal,
    groupChatFormData.chatUsers
  )
}
